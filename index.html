<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ€ãƒ³ãƒ—ãƒˆãƒ©ãƒƒã‚¯é‹æ¬å°æ•°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
    }

    .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .header p {
        opacity: 0.9;
        font-size: 14px;
    }

    .backup-status {
        position: absolute;
        top: 30px;
        right: 30px;
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .backup-status:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .tabs {
        display: flex;
        background: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
        overflow-x: auto;
    }

    .tab {
        padding: 15px 25px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 15px;
        color: #6c757d;
        transition: all 0.3s;
        white-space: nowrap;
        position: relative;
    }

    .tab:hover {
        background: #e9ecef;
        color: #495057;
    }

    .tab.active {
        color: #667eea;
        font-weight: bold;
    }

    .tab.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #667eea, #764ba2);
    }

    .tab-content {
        display: none;
        padding: 30px;
        animation: fadeIn 0.3s;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
        font-size: 20px;
        margin-bottom: 20px;
        color: #333;
        border-left: 4px solid #667eea;
        padding-left: 12px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #495057;
        font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    .btn-success {
        background: linear-gradient(135deg, #06C755 0%, #00B900 100%);
        color: white;
    }

    .btn-success:hover {
        transform: translateY(-2px);
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
        transform: translateY(-2px);
    }

    .btn-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }

    th {
        font-weight: 600;
        font-size: 14px;
    }

    td {
        font-size: 14px;
    }

    tbody tr:hover {
        background: #f8f9fa;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .action-buttons button {
        padding: 6px 12px;
        font-size: 13px;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .stat-card h3 {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 10px;
    }

    .stat-card .stat-value {
        font-size: 36px;
        font-weight: bold;
    }

    .share-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #06C755 0%, #00B900 100%);
        color: white;
        border: none;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(6, 199, 85, 0.4);
        transition: all 0.3s;
        z-index: 1000;
    }

    .share-button:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(6, 199, 85, 0.6);
    }

    @media print {
        body {
            background: white;
            padding: 0;
        }

        .container {
            box-shadow: none;
            border-radius: 0;
        }

        .header, .tabs, .btn-group, .share-button, .action-buttons {
            display: none !important;
        }

        .tab-content {
            display: block !important;
            padding: 0;
        }

        .card {
            box-shadow: none;
            page-break-inside: avoid;
        }

        table {
            page-break-inside: auto;
        }

        tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }

        @page {
            size: A4 landscape;
            margin: 15mm;
        }
    }

    @media (max-width: 768px) {
        body {
            padding: 0;
        }

        .container {
            border-radius: 0;
        }

        .header {
            padding: 20px;
        }

        .header h1 {
            font-size: 22px;
        }

        .backup-status {
            position: static;
            margin-top: 15px;
            display: inline-block;
        }

        .tab {
            padding: 12px 15px;
            font-size: 14px;
        }

        .tab-content {
            padding: 15px;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        table {
            font-size: 12px;
        }

        th, td {
            padding: 8px 4px;
        }

        .action-buttons {
            flex-direction: column;
        }

        .share-button {
            bottom: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            font-size: 20px;
        }
    }

    .filter-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .summary-table {
        margin-top: 30px;
    }

    .summary-table h3 {
        font-size: 18px;
        margin-bottom: 15px;
        color: #333;
    }

    .total-row {
        font-weight: bold;
        background: #e9ecef !important;
    }

    .intro-section {
        padding: 40px;
        text-align: center;
    }

    .intro-section h2 {
        font-size: 32px;
        margin-bottom: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .intro-section p {
        font-size: 16px;
        color: #6c757d;
        margin-bottom: 15px;
        line-height: 1.8;
    }

    .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 40px;
    }

    .feature-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
    }

    .feature-card-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }

    .feature-card h3 {
        font-size: 18px;
        margin-bottom: 10px;
    }

    .feature-card p {
        font-size: 14px;
        opacity: 0.9;
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸšš ãƒ€ãƒ³ãƒ—ãƒˆãƒ©ãƒƒã‚¯é‹æ¬å°æ•°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>å·¥äº‹åˆ¥ãƒ»è»Šä¸¡åˆ¥ã®é‹æ¬å°æ•°ã‚’ç°¡å˜ã«è¨˜éŒ²ãƒ»é›†è¨ˆã§ãã¾ã™ï¼ˆv1.0.1ï¼‰</p>
            <div class="backup-status" id="backupStatus" onclick="manualBackup()">
                ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æº–å‚™ä¸­...
            </div>
        </div>

```
    <div class="tabs">
        <button class="tab active" onclick="switchTab('home')">ğŸ  ãƒ›ãƒ¼ãƒ </button>
        <button class="tab" onclick="switchTab('projects')">ğŸ—ï¸ å·¥äº‹ãƒã‚¹ã‚¿ãƒ¼</button>
        <button class="tab" onclick="switchTab('vehicles')">ğŸšš è»Šä¸¡ãƒã‚¹ã‚¿ãƒ¼</button>
        <button class="tab" onclick="switchTab('records')">ğŸ“ é‹æ¬è¨˜éŒ²</button>
        <button class="tab" onclick="switchTab('summary')">ğŸ“Š é›†è¨ˆãƒ»å°åˆ·</button>
    </div>

    <!-- ãƒ›ãƒ¼ãƒ ã‚¿ãƒ– -->
    <div id="home" class="tab-content active">
        <div class="intro-section">
            <h2>ãƒ€ãƒ³ãƒ—ãƒˆãƒ©ãƒƒã‚¯é‹æ¬å°æ•°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h2>
            <p>å»ºè¨­ç¾å ´ã§ã®ãƒ€ãƒ³ãƒ—ãƒˆãƒ©ãƒƒã‚¯ã®é‹æ¬å°æ•°ã‚’åŠ¹ç‡çš„ã«ç®¡ç†ã§ãã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚</p>
            <p>å·¥äº‹ãƒ»è»Šä¸¡ã®ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†ã€æ—¥ã€…ã®é‹æ¬è¨˜éŒ²ã€å·¥äº‹åˆ¥ãƒ»è»Šä¸¡åˆ¥ã®é›†è¨ˆæ©Ÿèƒ½ã‚’å‚™ãˆã¦ã„ã¾ã™ã€‚</p>

            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-card-icon">ğŸ—ï¸</div>
                    <h3>å·¥äº‹ãƒã‚¹ã‚¿ãƒ¼</h3>
                    <p>å·¥äº‹åã€å·¥äº‹ç®‡æ‰€ã€è«‹è² è€…ã‚’ç™»éŒ²ãƒ»ç®¡ç†</p>
                </div>
                <div class="feature-card">
                    <div class="feature-card-icon">ğŸšš</div>
                    <h3>è»Šä¸¡ãƒã‚¹ã‚¿ãƒ¼</h3>
                    <p>è»Šç¨®ã€è»Šç•ªã€è·å°å¯¸æ³•ã€å®¹é‡ã‚’ç™»éŒ²ãƒ»ç®¡ç†</p>
                </div>
                <div class="feature-card">
                    <div class="feature-card-icon">ğŸ“</div>
                    <h3>é‹æ¬è¨˜éŒ²</h3>
                    <p>æ—¥ä»˜ãƒ»å·¥äº‹ãƒ»è»Šä¸¡ã”ã¨ã®é‹æ¬å°æ•°ã‚’è¨˜éŒ²</p>
                </div>
                <div class="feature-card">
                    <div class="feature-card-icon">ğŸ“Š</div>
                    <h3>é›†è¨ˆãƒ»å°åˆ·</h3>
                    <p>å·¥äº‹åˆ¥ãƒ»è»Šä¸¡åˆ¥ã«é›†è¨ˆã—ã¦å°åˆ·ãƒ»Excelå‡ºåŠ›</p>
                </div>
            </div>

            <div class="stats-grid" style="margin-top: 40px;">
                <div class="stat-card">
                    <h3>ç™»éŒ²å·¥äº‹æ•°</h3>
                    <div class="stat-value" id="projectCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>ç™»éŒ²è»Šä¸¡æ•°</h3>
                    <div class="stat-value" id="vehicleCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>è¨˜éŒ²ä»¶æ•°</h3>
                    <div class="stat-value" id="recordCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>ç·é‹æ¬å°æ•°</h3>
                    <div class="stat-value" id="totalCount">0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å·¥äº‹ãƒã‚¹ã‚¿ãƒ¼ã‚¿ãƒ– -->
    <div id="projects" class="tab-content">
        <div class="card">
            <h2>ğŸ—ï¸ å·¥äº‹ç™»éŒ²</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>å·¥äº‹å *</label>
                    <input type="text" id="projectName" placeholder="ä¾‹ï¼šâ—‹â—‹å»ºè¨­å·¥äº‹">
                </div>
                <div class="form-group">
                    <label>å·¥äº‹ç®‡æ‰€</label>
                    <input type="text" id="projectLocation" placeholder="ä¾‹ï¼šâ—‹â—‹å¸‚â–³â–³ç”º">
                </div>
                <div class="form-group">
                    <label>è«‹è² è€…åç§°</label>
                    <input type="text" id="projectContractor" placeholder="ä¾‹ï¼šæ ªå¼ä¼šç¤¾â—‹â—‹">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="addProject()">â• å·¥äº‹ã‚’è¿½åŠ </button>
                <button class="btn btn-secondary" onclick="clearProjectForm()">ğŸ”„ ã‚¯ãƒªã‚¢</button>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“‹ ç™»éŒ²æ¸ˆã¿å·¥äº‹ä¸€è¦§</h2>
            <div id="projectList"></div>
        </div>
    </div>

    <!-- è»Šä¸¡ãƒã‚¹ã‚¿ãƒ¼ã‚¿ãƒ– -->
    <div id="vehicles" class="tab-content">
        <div class="card">
            <h2>ğŸšš è»Šä¸¡ç™»éŒ²</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>è»Šç¨® *</label>
                    <input type="text" id="vehicleType" placeholder="ä¾‹ï¼š10tãƒ€ãƒ³ãƒ—">
                </div>
                <div class="form-group">
                    <label>è»Šç•ª *</label>
                    <input type="text" id="vehicleNumber" placeholder="ä¾‹ï¼šå“å·500ã‚1234">
                </div>
            </div>
            <h3 style="font-size: 16px; margin: 20px 0 10px 0; color: #495057;">ğŸ“ è·å°å¯¸æ³•</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>é•·ã•ï¼ˆmï¼‰</label>
                    <input type="number" id="vehicleLength" step="0.1" placeholder="ä¾‹ï¼š5.2" oninput="calculateCapacity()">
                </div>
                <div class="form-group">
                    <label>å¹…ï¼ˆmï¼‰</label>
                    <input type="number" id="vehicleWidth" step="0.1" placeholder="ä¾‹ï¼š2.3" oninput="calculateCapacity()">
                </div>
                <div class="form-group">
                    <label>é«˜ã•ï¼ˆmï¼‰</label>
                    <input type="number" id="vehicleHeight" step="0.1" placeholder="ä¾‹ï¼š0.6" oninput="calculateCapacity()">
                </div>
                <div class="form-group">
                    <label>å®¹é‡ï¼ˆmÂ³ï¼‰è‡ªå‹•è¨ˆç®—</label>
                    <input type="text" id="vehicleCapacity" readonly style="background: #f8f9fa; cursor: not-allowed;" placeholder="è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="addVehicle()">â• è»Šä¸¡ã‚’è¿½åŠ </button>
                <button class="btn btn-secondary" onclick="clearVehicleForm()">ğŸ”„ ã‚¯ãƒªã‚¢</button>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“‹ ç™»éŒ²æ¸ˆã¿è»Šä¸¡ä¸€è¦§</h2>
            <div id="vehicleList"></div>
        </div>
    </div>

    <!-- é‹æ¬è¨˜éŒ²ã‚¿ãƒ– -->
    <div id="records" class="tab-content">
        <div class="card">
            <h2>ğŸ“ é‹æ¬è¨˜éŒ²å…¥åŠ›</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>æ—¥ä»˜ *</label>
                    <input type="date" id="recordDate">
                </div>
                <div class="form-group">
                    <label>å·¥äº‹ *</label>
                    <select id="recordProject">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è»Šä¸¡ *</label>
                    <select id="recordVehicle">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é‹æ¬å°æ•° *</label>
                    <input type="number" id="recordCount" min="1" placeholder="ä¾‹ï¼š15">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="addRecord()">â• è¨˜éŒ²ã‚’è¿½åŠ </button>
                <button class="btn btn-secondary" onclick="clearRecordForm()">ğŸ”„ ã‚¯ãƒªã‚¢</button>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“‹ é‹æ¬è¨˜éŒ²ä¸€è¦§</h2>
            <div id="recordList"></div>
        </div>
    </div>

    <!-- é›†è¨ˆãƒ»å°åˆ·ã‚¿ãƒ– -->
    <div id="summary" class="tab-content">
        <div class="card">
            <h2>ğŸ“Š é›†è¨ˆæ¡ä»¶è¨­å®š</h2>
            <div class="filter-section">
                <div class="filter-grid">
                    <div class="form-group">
                        <label>é–‹å§‹æ—¥</label>
                        <input type="date" id="summaryStartDate">
                    </div>
                    <div class="form-group">
                        <label>çµ‚äº†æ—¥</label>
                        <input type="date" id="summaryEndDate">
                    </div>
                    <div class="form-group">
                        <label>å·¥äº‹</label>
                        <select id="summaryProject">
                            <option value="">ã™ã¹ã¦</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è»Šä¸¡</label>
                        <select id="summaryVehicle">
                            <option value="">ã™ã¹ã¦</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="generateSummary()">ğŸ“Š é›†è¨ˆå®Ÿè¡Œ</button>
                <button class="btn btn-success" onclick="exportSummaryToExcel()">ğŸ“„ Excelå‡ºåŠ›</button>
                <button class="btn btn-secondary" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·</button>
            </div>
        </div>

        <div class="card" id="summaryResults" style="display: none;">
            <h2>ğŸ“ˆ é›†è¨ˆçµæœ</h2>
            <div id="summaryContent"></div>
        </div>
    </div>
</div>

<button class="share-button" onclick="shareData()" title="ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰">ğŸ“¤</button>

<script>
    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
    let projects = [];
    let vehicles = [];
    let records = [];
    let editingProjectId = null;
    let editingVehicleId = null;
    let editingRecordId = null;

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        updateAllSelects();
        updateStats();
        initAutoBackup();
        registerServiceWorker();
        
        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('recordDate').value = today;
        document.getElementById('summaryEndDate').value = today;
        
        // 30æ—¥å‰ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        document.getElementById('summaryStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    });

    // Service Workerç™»éŒ²
    function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed:', err));
        }
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(tabName).classList.add('active');
        
        if (tabName === 'home') {
            updateStats();
        }
    }

    // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    function saveData() {
        localStorage.setItem('dumpTruckProjects', JSON.stringify(projects));
        localStorage.setItem('dumpTruckVehicles', JSON.stringify(vehicles));
        localStorage.setItem('dumpTruckRecords', JSON.stringify(records));
    }

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadData() {
        projects = JSON.parse(localStorage.getItem('dumpTruckProjects')) || [];
        vehicles = JSON.parse(localStorage.getItem('dumpTruckVehicles')) || [];
        records = JSON.parse(localStorage.getItem('dumpTruckRecords')) || [];
        
        renderProjectList();
        renderVehicleList();
        renderRecordList();
    }

    // å·¥äº‹è¿½åŠ ãƒ»æ›´æ–°
    function addProject() {
        const name = document.getElementById('projectName').value.trim();
        const location = document.getElementById('projectLocation').value.trim();
        const contractor = document.getElementById('projectContractor').value.trim();
        
        if (!name) {
            alert('âŒ å·¥äº‹åã¯å¿…é ˆã§ã™ã€‚');
            return;
        }
        
        if (editingProjectId) {
            const project = projects.find(p => p.id === editingProjectId);
            project.name = name;
            project.location = location;
            project.contractor = contractor;
            editingProjectId = null;
        } else {
            projects.push({
                id: Date.now().toString(),
                name,
                location,
                contractor
            });
        }
        
        saveData();
        renderProjectList();
        updateAllSelects();
        clearProjectForm();
        alert('âœ… å·¥äº‹ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
    }

    // å·¥äº‹ç·¨é›†
    function editProject(id) {
        const project = projects.find(p => p.id === id);
        document.getElementById('projectName').value = project.name;
        document.getElementById('projectLocation').value = project.location;
        document.getElementById('projectContractor').value = project.contractor;
        editingProjectId = id;
        
        document.querySelector('.tab[onclick*="projects"]').click();
        window.scrollTo(0, 0);
    }

    // å·¥äº‹å‰Šé™¤
    function deleteProject(id) {
        if (!confirm('ã“ã®å·¥äº‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\né–¢é€£ã™ã‚‹é‹æ¬è¨˜éŒ²ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) return;
        
        projects = projects.filter(p => p.id !== id);
        records = records.filter(r => r.projectId !== id);
        saveData();
        renderProjectList();
        renderRecordList();
        updateAllSelects();
        updateStats();
    }

    // å·¥äº‹ãƒªã‚¹ãƒˆè¡¨ç¤º
    function renderProjectList() {
        const container = document.getElementById('projectList');
        
        if (projects.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ—ï¸</div>
                    <p>ã¾ã å·¥äº‹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                    <p>ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å·¥äº‹ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            `;
            return;
        }
        
        let html = '<table><thead><tr><th>å·¥äº‹å</th><th>å·¥äº‹ç®‡æ‰€</th><th>è«‹è² è€…</th><th>æ“ä½œ</th></tr></thead><tbody>';
        
        projects.forEach(project => {
            html += `
                <tr>
                    <td><strong>${project.name}</strong></td>
                    <td>${project.location || '-'}</td>
                    <td>${project.contractor || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="editProject('${project.id}')">âœï¸ ç·¨é›†</button>
                            <button class="btn btn-danger" onclick="deleteProject('${project.id}')">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // å®¹é‡è‡ªå‹•è¨ˆç®—
    function calculateCapacity() {
        const length = parseFloat(document.getElementById('vehicleLength').value) || 0;
        const width = parseFloat(document.getElementById('vehicleWidth').value) || 0;
        const height = parseFloat(document.getElementById('vehicleHeight').value) || 0;
        
        if (length > 0 && width > 0 && height > 0) {
            const capacity = (length * width * height).toFixed(2);
            document.getElementById('vehicleCapacity').value = capacity;
        } else {
            document.getElementById('vehicleCapacity').value = '';
        }
    }

    // è»Šä¸¡è¿½åŠ ãƒ»æ›´æ–°
    function addVehicle() {
        const type = document.getElementById('vehicleType').value.trim();
        const number = document.getElementById('vehicleNumber').value.trim();
        const length = parseFloat(document.getElementById('vehicleLength').value) || null;
        const width = parseFloat(document.getElementById('vehicleWidth').value) || null;
        const height = parseFloat(document.getElementById('vehicleHeight').value) || null;
        const capacity = document.getElementById('vehicleCapacity').value;
        
        if (!type || !number) {
            alert('âŒ è»Šç¨®ã¨è»Šç•ªã¯å¿…é ˆã§ã™ã€‚');
            return;
        }
        
        if (editingVehicleId) {
            const vehicle = vehicles.find(v => v.id === editingVehicleId);
            vehicle.type = type;
            vehicle.number = number;
            vehicle.length = length;
            vehicle.width = width;
            vehicle.height = height;
            vehicle.capacity = capacity ? parseFloat(capacity) : null;
            editingVehicleId = null;
        } else {
            vehicles.push({
                id: Date.now().toString(),
                type,
                number,
                length,
                width,
                height,
                capacity: capacity ? parseFloat(capacity) : null
            });
        }
        
        saveData();
        renderVehicleList();
        updateAllSelects();
        clearVehicleForm();
        alert('âœ… è»Šä¸¡ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
    }

    // è»Šä¸¡ç·¨é›†
    function editVehicle(id) {
        const vehicle = vehicles.find(v => v.id === id);
        document.getElementById('vehicleType').value = vehicle.type;
        document.getElementById('vehicleNumber').value = vehicle.number;
        document.getElementById('vehicleLength').value = vehicle.length || '';
        document.getElementById('vehicleWidth').value = vehicle.width || '';
        document.getElementById('vehicleHeight').value = vehicle.height || '';
        document.getElementById('vehicleCapacity').value = vehicle.capacity || '';
        editingVehicleId = id;
        
        document.querySelector('.tab[onclick*="vehicles"]').click();
        window.scrollTo(0, 0);
    }

    // è»Šä¸¡å‰Šé™¤
    function deleteVehicle(id) {
        if (!confirm('ã“ã®è»Šä¸¡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\né–¢é€£ã™ã‚‹é‹æ¬è¨˜éŒ²ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) return;
        
        vehicles = vehicles.filter(v => v.id !== id);
        records = records.filter(r => r.vehicleId !== id);
        saveData();
        renderVehicleList();
        renderRecordList();
        updateAllSelects();
        updateStats();
    }

    // è»Šä¸¡ãƒªã‚¹ãƒˆè¡¨ç¤º
    function renderVehicleList() {
        const container = document.getElementById('vehicleList');
        
        if (vehicles.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸšš</div>
                    <p>ã¾ã è»Šä¸¡ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                    <p>ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è»Šä¸¡ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            `;
            return;
        }
        
        let html = '<table><thead><tr><th>è»Šç¨®</th><th>è»Šç•ª</th><th>è·å°å¯¸æ³•</th><th>å®¹é‡</th><th>æ“ä½œ</th></tr></thead><tbody>';
        
        vehicles.forEach(vehicle => {
            // å¯¸æ³•è¡¨ç¤º
            let dimensionText = '-';
            if (vehicle.length && vehicle.width && vehicle.height) {
                dimensionText = `${vehicle.length}m Ã— ${vehicle.width}m Ã— ${vehicle.height}m`;
            } else if (vehicle.bodySize) {
                // æ—§ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
                dimensionText = vehicle.bodySize;
            }
            
            html += `
                <tr>
                    <td><strong>${vehicle.type}</strong></td>
                    <td>${vehicle.number}</td>
                    <td>${dimensionText}</td>
                    <td>${vehicle.capacity ? vehicle.capacity + 'mÂ³' : '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="editVehicle('${vehicle.id}')">âœï¸ ç·¨é›†</button>
                            <button class="btn btn-danger" onclick="deleteVehicle('${vehicle.id}')">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // é‹æ¬è¨˜éŒ²è¿½åŠ ãƒ»æ›´æ–°
    function addRecord() {
        const date = document.getElementById('recordDate').value;
        const projectId = document.getElementById('recordProject').value;
        const vehicleId = document.getElementById('recordVehicle').value;
        const count = parseInt(document.getElementById('recordCount').value);
        
        if (!date || !projectId || !vehicleId || !count || count < 1) {
            alert('âŒ ã™ã¹ã¦ã®é …ç›®ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        if (editingRecordId) {
            const record = records.find(r => r.id === editingRecordId);
            record.date = date;
            record.projectId = projectId;
            record.vehicleId = vehicleId;
            record.count = count;
            editingRecordId = null;
        } else {
            records.push({
                id: Date.now().toString(),
                date,
                projectId,
                vehicleId,
                count
            });
        }
        
        saveData();
        renderRecordList();
        clearRecordForm();
        updateStats();
        alert('âœ… é‹æ¬è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
    }

    // é‹æ¬è¨˜éŒ²ç·¨é›†
    function editRecord(id) {
        const record = records.find(r => r.id === id);
        document.getElementById('recordDate').value = record.date;
        document.getElementById('recordProject').value = record.projectId;
        document.getElementById('recordVehicle').value = record.vehicleId;
        document.getElementById('recordCount').value = record.count;
        editingRecordId = id;
        
        document.querySelector('.tab[onclick*="records"]').click();
        window.scrollTo(0, 0);
    }

    // é‹æ¬è¨˜éŒ²å‰Šé™¤
    function deleteRecord(id) {
        if (!confirm('ã“ã®é‹æ¬è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        
        records = records.filter(r => r.id !== id);
        saveData();
        renderRecordList();
        updateStats();
    }

    // é‹æ¬è¨˜éŒ²ãƒªã‚¹ãƒˆè¡¨ç¤º
    function renderRecordList() {
        const container = document.getElementById('recordList');
        
        if (records.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“</div>
                    <p>ã¾ã é‹æ¬è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    <p>ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰é‹æ¬è¨˜éŒ²ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            `;
            return;
        }
        
        // æ—¥ä»˜é™é †ã§ã‚½ãƒ¼ãƒˆ
        const sortedRecords = [...records].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        let html = '<table><thead><tr><th>æ—¥ä»˜</th><th>å·¥äº‹</th><th>è»Šä¸¡</th><th>è»Šç•ª</th><th>é‹æ¬å°æ•°</th><th>æ“ä½œ</th></tr></thead><tbody>';
        
        sortedRecords.forEach(record => {
            const project = projects.find(p => p.id === record.projectId);
            const vehicle = vehicles.find(v => v.id === record.vehicleId);
            
            html += `
                <tr>
                    <td>${record.date}</td>
                    <td>${project ? project.name : 'ï¼ˆå‰Šé™¤æ¸ˆã¿ï¼‰'}</td>
                    <td>${vehicle ? vehicle.type : 'ï¼ˆå‰Šé™¤æ¸ˆã¿ï¼‰'}</td>
                    <td>${vehicle ? vehicle.number : '-'}</td>
                    <td><strong>${record.count}å°</strong></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="editRecord('${record.id}')">âœï¸ ç·¨é›†</button>
                            <button class="btn btn-danger" onclick="deleteRecord('${record.id}')">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹æ›´æ–°
    function updateAllSelects() {
        // é‹æ¬è¨˜éŒ²ã®å·¥äº‹é¸æŠ
        const recordProject = document.getElementById('recordProject');
        recordProject.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        projects.forEach(project => {
            recordProject.innerHTML += `<option value="${project.id}">${project.name}</option>`;
        });
        
        // é‹æ¬è¨˜éŒ²ã®è»Šä¸¡é¸æŠ
        const recordVehicle = document.getElementById('recordVehicle');
        recordVehicle.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        vehicles.forEach(vehicle => {
            recordVehicle.innerHTML += `<option value="${vehicle.id}">${vehicle.type} (${vehicle.number})</option>`;
        });
        
        // é›†è¨ˆã®å·¥äº‹é¸æŠ
        const summaryProject = document.getElementById('summaryProject');
        summaryProject.innerHTML = '<option value="">ã™ã¹ã¦</option>';
        projects.forEach(project => {
            summaryProject.innerHTML += `<option value="${project.id}">${project.name}</option>`;
        });
        
        // é›†è¨ˆã®è»Šä¸¡é¸æŠ
        const summaryVehicle = document.getElementById('summaryVehicle');
        summaryVehicle.innerHTML = '<option value="">ã™ã¹ã¦</option>';
        vehicles.forEach(vehicle => {
            summaryVehicle.innerHTML += `<option value="${vehicle.id}">${vehicle.type} (${vehicle.number})</option>`;
        });
    }

    // çµ±è¨ˆæ›´æ–°
    function updateStats() {
        document.getElementById('projectCount').textContent = projects.length;
        document.getElementById('vehicleCount').textContent = vehicles.length;
        document.getElementById('recordCount').textContent = records.length;
        
        const totalCount = records.reduce((sum, record) => sum + record.count, 0);
        document.getElementById('totalCount').textContent = totalCount;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
    function clearProjectForm() {
        document.getElementById('projectName').value = '';
        document.getElementById('projectLocation').value = '';
        document.getElementById('projectContractor').value = '';
        editingProjectId = null;
    }

    function clearVehicleForm() {
        document.getElementById('vehicleType').value = '';
        document.getElementById('vehicleNumber').value = '';
        document.getElementById('vehicleLength').value = '';
        document.getElementById('vehicleWidth').value = '';
        document.getElementById('vehicleHeight').value = '';
        document.getElementById('vehicleCapacity').value = '';
        editingVehicleId = null;
    }

    function clearRecordForm() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('recordDate').value = today;
        document.getElementById('recordProject').value = '';
        document.getElementById('recordVehicle').value = '';
        document.getElementById('recordCount').value = '';
        editingRecordId = null;
    }

    // é›†è¨ˆå®Ÿè¡Œ
    function generateSummary() {
        const startDate = document.getElementById('summaryStartDate').value;
        const endDate = document.getElementById('summaryEndDate').value;
        const projectId = document.getElementById('summaryProject').value;
        const vehicleId = document.getElementById('summaryVehicle').value;
        
        if (!startDate || !endDate) {
            alert('âŒ é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        let filteredRecords = records.filter(record => {
            if (record.date < startDate || record.date > endDate) return false;
            if (projectId && record.projectId !== projectId) return false;
            if (vehicleId && record.vehicleId !== vehicleId) return false;
            return true;
        });
        
        if (filteredRecords.length === 0) {
            alert('âš ï¸ è©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }
        
        // å·¥äº‹åˆ¥é›†è¨ˆ
        const projectSummary = {};
        filteredRecords.forEach(record => {
            if (!projectSummary[record.projectId]) {
                projectSummary[record.projectId] = 0;
            }
            projectSummary[record.projectId] += record.count;
        });
        
        // è»Šä¸¡åˆ¥é›†è¨ˆ
        const vehicleSummary = {};
        filteredRecords.forEach(record => {
            if (!vehicleSummary[record.vehicleId]) {
                vehicleSummary[record.vehicleId] = 0;
            }
            vehicleSummary[record.vehicleId] += record.count;
        });
        
        // æ—¥ä»˜åˆ¥é›†è¨ˆ
        const dateSummary = {};
        filteredRecords.forEach(record => {
            if (!dateSummary[record.date]) {
                dateSummary[record.date] = 0;
            }
            dateSummary[record.date] += record.count;
        });
        
        // è¡¨ç¤º
        let html = `
            <div class="summary-table">
                <h3>ğŸ“Š å·¥äº‹åˆ¥é›†è¨ˆ</h3>
                <table>
                    <thead>
                        <tr>
                            <th>å·¥äº‹å</th>
                            <th>å·¥äº‹ç®‡æ‰€</th>
                            <th>é‹æ¬å°æ•°</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        let projectTotal = 0;
        Object.keys(projectSummary).forEach(pId => {
            const project = projects.find(p => p.id === pId);
            if (project) {
                html += `
                    <tr>
                        <td>${project.name}</td>
                        <td>${project.location || '-'}</td>
                        <td><strong>${projectSummary[pId]}å°</strong></td>
                    </tr>
                `;
                projectTotal += projectSummary[pId];
            }
        });
        
        html += `
                    <tr class="total-row">
                        <td colspan="2">åˆè¨ˆ</td>
                        <td><strong>${projectTotal}å°</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="summary-table">
            <h3>ğŸšš è»Šä¸¡åˆ¥é›†è¨ˆ</h3>
            <table>
                <thead>
                    <tr>
                        <th>è»Šç¨®</th>
                        <th>è»Šç•ª</th>
                        <th>è·å°å¯¸æ³•</th>
                        <th>å®¹é‡</th>
                        <th>é‹æ¬å°æ•°</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        let vehicleTotal = 0;
        Object.keys(vehicleSummary).forEach(vId => {
            const vehicle = vehicles.find(v => v.id === vId);
            if (vehicle) {
                // å¯¸æ³•è¡¨ç¤º
                let dimensionText = '-';
                if (vehicle.length && vehicle.width && vehicle.height) {
                    dimensionText = `${vehicle.length}m Ã— ${vehicle.width}m Ã— ${vehicle.height}m`;
                } else if (vehicle.bodySize) {
                    dimensionText = vehicle.bodySize;
                }
                
                html += `
                    <tr>
                        <td>${vehicle.type}</td>
                        <td>${vehicle.number}</td>
                        <td>${dimensionText}</td>
                        <td>${vehicle.capacity ? vehicle.capacity + 'mÂ³' : '-'}</td>
                        <td><strong>${vehicleSummary[vId]}å°</strong></td>
                    </tr>
                `;
                vehicleTotal += vehicleSummary[vId];
            }
        });
        
        html += `
                    <tr class="total-row">
                        <td colspan="4">åˆè¨ˆ</td>
                        <td><strong>${vehicleTotal}å°</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="summary-table">
            <h3>ğŸ“… æ—¥ä»˜åˆ¥é›†è¨ˆ</h3>
            <table>
                <thead>
                    <tr>
                        <th>æ—¥ä»˜</th>
                        <th>é‹æ¬å°æ•°</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        const sortedDates = Object.keys(dateSummary).sort();
        let dateTotal = 0;
        sortedDates.forEach(date => {
            html += `
                <tr>
                    <td>${date}</td>
                    <td><strong>${dateSummary[date]}å°</strong></td>
                </tr>
            `;
            dateTotal += dateSummary[date];
        });
        
        html += `
                    <tr class="total-row">
                        <td>åˆè¨ˆ</td>
                        <td><strong>${dateTotal}å°</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
        `;
        
        document.getElementById('summaryContent').innerHTML = html;
        document.getElementById('summaryResults').style.display = 'block';
    }

    // Excelå‡ºåŠ›
    function exportSummaryToExcel() {
        const startDate = document.getElementById('summaryStartDate').value;
        const endDate = document.getElementById('summaryEndDate').value;
        const projectId = document.getElementById('summaryProject').value;
        const vehicleId = document.getElementById('summaryVehicle').value;
        
        if (!startDate || !endDate) {
            alert('âŒ é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        let filteredRecords = records.filter(record => {
            if (record.date < startDate || record.date > endDate) return false;
            if (projectId && record.projectId !== projectId) return false;
            if (vehicleId && record.vehicleId !== vehicleId) return false;
            return true;
        });
        
        if (filteredRecords.length === 0) {
            alert('âš ï¸ è©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }
        
        const workbook = XLSX.utils.book_new();
        
        // å·¥äº‹åˆ¥é›†è¨ˆã‚·ãƒ¼ãƒˆ
        const projectData = [
            ['å·¥äº‹åˆ¥é‹æ¬å°æ•°é›†è¨ˆ'],
            ['æœŸé–“', `${startDate} ã€œ ${endDate}`],
            [],
            ['å·¥äº‹å', 'å·¥äº‹ç®‡æ‰€', 'è«‹è² è€…', 'é‹æ¬å°æ•°']
        ];
        
        const projectSummary = {};
        filteredRecords.forEach(record => {
            if (!projectSummary[record.projectId]) {
                projectSummary[record.projectId] = 0;
            }
            projectSummary[record.projectId] += record.count;
        });
        
        let projectTotal = 0;
        Object.keys(projectSummary).forEach(pId => {
            const project = projects.find(p => p.id === pId);
            if (project) {
                projectData.push([
                    project.name,
                    project.location || '',
                    project.contractor || '',
                    projectSummary[pId]
                ]);
                projectTotal += projectSummary[pId];
            }
        });
        
        projectData.push(['', '', 'åˆè¨ˆ', projectTotal]);
        
        const projectSheet = XLSX.utils.aoa_to_sheet(projectData);
        projectSheet['!cols'] = [
            { wch: 30 },
            { wch: 25 },
            { wch: 25 },
            { wch: 12 }
        ];
        XLSX.utils.book_append_sheet(workbook, projectSheet, 'å·¥äº‹åˆ¥é›†è¨ˆ');
        
        // è»Šä¸¡åˆ¥é›†è¨ˆã‚·ãƒ¼ãƒˆ
        const vehicleData = [
            ['è»Šä¸¡åˆ¥é‹æ¬å°æ•°é›†è¨ˆ'],
            ['æœŸé–“', `${startDate} ã€œ ${endDate}`],
            [],
            ['è»Šç¨®', 'è»Šç•ª', 'è·å°å¯¸æ³•', 'å®¹é‡', 'é‹æ¬å°æ•°']
        ];
        
        const vehicleSummary = {};
        filteredRecords.forEach(record => {
            if (!vehicleSummary[record.vehicleId]) {
                vehicleSummary[record.vehicleId] = 0;
            }
            vehicleSummary[record.vehicleId] += record.count;
        });
        
        let vehicleTotal = 0;
        Object.keys(vehicleSummary).forEach(vId => {
            const vehicle = vehicles.find(v => v.id === vId);
            if (vehicle) {
                // å¯¸æ³•è¡¨ç¤º
                let dimensionText = '';
                if (vehicle.length && vehicle.width && vehicle.height) {
                    dimensionText = `${vehicle.length}m Ã— ${vehicle.width}m Ã— ${vehicle.height}m`;
                } else if (vehicle.bodySize) {
                    dimensionText = vehicle.bodySize;
                }
                
                vehicleData.push([
                    vehicle.type,
                    vehicle.number,
                    dimensionText,
                    vehicle.capacity ? vehicle.capacity + 'mÂ³' : '',
                    vehicleSummary[vId]
                ]);
                vehicleTotal += vehicleSummary[vId];
            }
        });
        
        vehicleData.push(['', '', '', 'åˆè¨ˆ', vehicleTotal]);
        
        const vehicleSheet = XLSX.utils.aoa_to_sheet(vehicleData);
        vehicleSheet['!cols'] = [
            { wch: 15 },
            { wch: 20 },
            { wch: 25 },
            { wch: 10 },
            { wch: 12 }
        ];
        XLSX.utils.book_append_sheet(workbook, vehicleSheet, 'è»Šä¸¡åˆ¥é›†è¨ˆ');
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
        const fileName = `é‹æ¬å°æ•°é›†è¨ˆ_${startDate}_${endDate}.xlsx`;
        XLSX.writeFile(workbook, fileName);
        
        alert('âœ… Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
    }

    // ãƒ‡ãƒ¼ã‚¿å…±æœ‰
    async function shareData() {
        const data = {
            projects,
            vehicles,
            records,
            exportDate: new Date().toISOString()
        };
        
        const jsonString = JSON.stringify(data, null, 2);
        const dateStr = new Date().toISOString().split('T')[0];
        
        // å…±æœ‰æ–¹æ³•é¸æŠ
        const choice = await showShareOptions();
        
        if (choice === 'cancel') return;
        
        let fileName, mimeType;
        
        if (choice === 'txt') {
            fileName = `dump-truck-data-${dateStr}.txt`;
            mimeType = 'text/plain;charset=utf-8';
        } else if (choice === 'text-only') {
            await shareAsText(jsonString);
            return;
        } else {
            fileName = `dump-truck-data-${dateStr}.json`;
            mimeType = 'application/json;charset=utf-8';
        }
        
        // Web Share API
        if (navigator.share) {
            try {
                const blob = new Blob([jsonString], { type: mimeType });
                const file = new File([blob], fileName, { type: mimeType });
                
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        title: 'ãƒ€ãƒ³ãƒ—ãƒˆãƒ©ãƒƒã‚¯é‹æ¬å°æ•°ç®¡ç†ãƒ‡ãƒ¼ã‚¿',
                        text: `é‹æ¬å°æ•°ç®¡ç†ãƒ‡ãƒ¼ã‚¿ï¼ˆ${projects.length}ä»¶ã®å·¥äº‹ã€${vehicles.length}å°ã®è»Šä¸¡ã€${records.length}ä»¶ã®è¨˜éŒ²ï¼‰`,
                        files: [file]
                    });
                    
                    alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã—ã¾ã—ãŸï¼');
                    localStorage.setItem('lastBackupTime', new Date().toISOString());
                    updateBackupStatus('success', 'å…±æœ‰å®Œäº†');
                    return;
                }
            } catch (error) {
                if (error.name === 'AbortError') return;
                console.log('Web Share API ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹å¼
        try {
            const blob = new Blob([jsonString], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.style.display = 'none';
            
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            alert('âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼\n\nãƒ•ã‚¡ã‚¤ãƒ«å: ' + fileName);
            localStorage.setItem('lastBackupTime', new Date().toISOString());
            updateBackupStatus('success', 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†');
        } catch (error) {
            console.error('Download error:', error);
            showJsonDialog(jsonString, fileName);
        }
    }

    // å…±æœ‰æ–¹æ³•é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    function showShareOptions() {
        return new Promise((resolve) => {
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 25px;
                max-width: 400px;
                width: 100%;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <h3 style="margin-top: 0; color: #333; font-size: 20px;">ğŸ“¤ å…±æœ‰æ–¹æ³•ã‚’é¸æŠ</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                    LINEã§å…±æœ‰ã™ã‚‹å ´åˆã¯ã€ŒTXTå½¢å¼ã€ã‚’æ¨å¥¨ã—ã¾ã™
                </p>
                
                <button onclick="selectShare('txt')" style="
                    width: 100%;
                    padding: 15px;
                    margin-bottom: 10px;
                    background: linear-gradient(135deg, #06C755 0%, #00B900 100%);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: bold;
                    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                ">
                    ğŸ“± TXTå½¢å¼ï¼ˆLINEæ¨å¥¨ï¼‰
                </button>
                
                <button onclick="selectShare('json')" style="
                    width: 100%;
                    padding: 15px;
                    margin-bottom: 10px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: bold;
                    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                ">
                    ğŸ’¾ JSONå½¢å¼ï¼ˆæ¨™æº–ï¼‰
                </button>
                
                <button onclick="selectShare('text-only')" style="
                    width: 100%;
                    padding: 15px;
                    margin-bottom: 10px;
                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: bold;
                    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                ">
                    ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆã®ã¿
                </button>
                
                <button onclick="selectShare('cancel')" style="
                    width: 100%;
                    padding: 12px;
                    background: #e0e0e0;
                    color: #666;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 14px;
                ">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            `;
            
            dialog.appendChild(content);
            document.body.appendChild(dialog);
            
            window.selectShare = function(choice) {
                document.body.removeChild(dialog);
                delete window.selectShare;
                resolve(choice);
            };
        });
    }

    // ãƒ†ã‚­ã‚¹ãƒˆã®ã¿å…±æœ‰
    async function shareAsText(jsonString) {
        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'ãƒ€ãƒ³ãƒ—ãƒˆãƒ©ãƒƒã‚¯é‹æ¬å°æ•°ç®¡ç†ãƒ‡ãƒ¼ã‚¿',
                    text: jsonString
                });
                
                alert('âœ… ãƒ†ã‚­ã‚¹ãƒˆã‚’å…±æœ‰ã—ã¾ã—ãŸï¼');
                localStorage.setItem('lastBackupTime', new Date().toISOString());
                updateBackupStatus('success', 'å…±æœ‰å®Œäº†');
            } catch (error) {
                if (error.name !== 'AbortError') {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(jsonString);
                        alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
                    }
                }
            }
        } else {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(jsonString);
                alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            }
        }
    }

    // JSONãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
    function showJsonDialog(jsonString, fileName) {
        const dialog = document.createElement('div');
        dialog.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
            background: white;
            border-radius: 10px;
            padding: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: auto;
        `;
        
        content.innerHTML = `
            <h3 style="margin-top: 0;">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ã®ã‚³ãƒ”ãƒ¼</h3>
            <p style="color: #666; font-size: 14px;">
                ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ã€Œ${fileName}ã€ã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
            </p>
            <textarea id="jsonTextArea" style="
                width: 100%;
                height: 300px;
                border: 2px solid #ddd;
                border-radius: 5px;
                padding: 10px;
                font-family: monospace;
                font-size: 12px;
            " readonly>${jsonString}</textarea>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button onclick="copyJsonText()" style="
                    flex: 1;
                    padding: 12px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                ">ğŸ“‹ ã‚³ãƒ”ãƒ¼ã™ã‚‹</button>
                <button onclick="closeJsonDialog()" style="
                    flex: 1;
                    padding: 12px;
                    background: #6c757d;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                ">é–‰ã˜ã‚‹</button>
            </div>
        `;
        
        dialog.appendChild(content);
        document.body.appendChild(dialog);
        
        window.copyJsonText = function() {
            const textarea = document.getElementById('jsonTextArea');
            textarea.select();
            try {
                document.execCommand('copy');
                alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            } catch (err) {
                alert('âš ï¸ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        };
        
        window.closeJsonDialog = function() {
            document.body.removeChild(dialog);
            delete window.copyJsonText;
            delete window.closeJsonDialog;
        };
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json,.json,.txt,text/plain';
        input.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    if (confirm('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
                        projects = data.projects || [];
                        vehicles = data.vehicles || [];
                        records = data.records || [];
                        
                        saveData();
                        renderProjectList();
                        renderVehicleList();
                        renderRecordList();
                        updateAllSelects();
                        updateStats();
                        
                        alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼');
                    }
                } catch (error) {
                    alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    // è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    function initAutoBackup() {
        checkBackupStatus();
        setInterval(checkBackupStatus, 60000); // 1åˆ†ã”ã¨
    }

    function checkBackupStatus() {
        const lastBackup = localStorage.getItem('lastBackupTime');
        
        if (!lastBackup) {
            updateBackupStatus('warning', 'æœªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—');
            return;
        }
        
        const lastBackupDate = new Date(lastBackup);
        const now = new Date();
        const hoursDiff = (now - lastBackupDate) / (1000 * 60 * 60);
        
        if (hoursDiff < 24) {
            updateBackupStatus('success', 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¸ˆã¿');
        } else {
            updateBackupStatus('warning', 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¨å¥¨');
        }
    }

    function updateBackupStatus(status, text) {
        const statusEl = document.getElementById('backupStatus');
        if (status === 'success') {
            statusEl.textContent = 'âœ… ' + text;
        } else if (status === 'warning') {
            statusEl.textContent = 'âš ï¸ ' + text;
        }
    }

    function manualBackup() {
        shareData();
    }
</script>
```

</body>
</html>